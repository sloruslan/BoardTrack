create table "PRODUCTION_STEP"
(
    id           bigint primary key,
    created_at   timestamp default timezone('utc'::text, now()) not null,
    updated_at   timestamp default timezone('utc'::text, now()) not null,

    name         varchar not null
);

INSERT INTO public."PRODUCTION_STEP"
(id, created_at, updated_at, name)
VALUES
    (1, now(), now(), 'Регистрация'),
    (2, now(), now(), 'Установка компонентов'),
    (3, now(), now(), 'Контроль качества'),
    (4, now(), now(), 'Ремонт'),
    (5, now(), now(), 'Упаковывание');

create table "BOARD_TYPE"
(
    id           bigint generated always as identity
        primary key,
    created_at   timestamp default timezone('utc'::text, now()) not null,
    updated_at   timestamp default timezone('utc'::text, now()) not null,

    name         varchar not null,
    description      text
);

create table "BOARD"
(
    id           bigint generated always as identity,
    created_at   timestamp default timezone('utc'::text, now()) not null,
    updated_at   timestamp default timezone('utc'::text, now()) not null,

    name         varchar not null,
    serial       varchar not null,
    type_id         bigint not null references public."BOARD_TYPE" (id),
    current_step_id smallint not null references public."PRODUCTION_STEP" (id),
    constraint "PK_BOARD"
        primary key (id)

)


create table "PRODUCTION_STEP_RULE"
(
    id              bigint primary key,
    created_at      timestamp default timezone('utc'::text, now()) not null,
    updated_at      timestamp default timezone('utc'::text, now()) not null,

    current_step_id smallint not null references public."PRODUCTION_STEP" (id),
    valid_next_step_id   smallint not null references public."PRODUCTION_STEP" (id),
    description     varchar
);

INSERT INTO public."PRODUCTION_STEP_RULE"
(id, created_at, updated_at, current_step_id, valid_next_step_id, description)
VALUES
    (1, now(), now(), 1, 2, ''),
    (2, now(), now(), 2, 3, ''),
    (3, now(), now(), 3, 4, ''),
    (4, now(), now(), 4, 3, ''),
    (5, now(), now(), 3, 5, ''),

    (6, now(), now(), 1, 1, ''),
    (7, now(), now(), 2, 2, ''),
    (8, now(), now(), 3, 3, ''),
    (9, now(), now(), 4, 4, ''),
    (10, now(), now(), 5, 5, '');



create table "BOARD_HISTORY"
(
    id           bigint generated always as identity,
    from_step_id smallint,
    to_step_id   smallint not null,
    moved_at     timestamp default timezone('utc'::text, now()) not null,
    moved_by_user_id BIGINT NULL,
    comment TEXT NULL,
    board_id bigint not null,

    constraint "PK_BOARD_HISTORY"
        primary key (id, moved_at)

) PARTITION BY RANGE (moved_at);
CREATE TABLE "BOARD_HISTORY_DEFAULT" PARTITION OF "BOARD_HISTORY" default;

create index "BOARD_HISTORY_board_id_index"
    on public."BOARD_HISTORY" (board_id);


create table public."ROLE"
(
    id  bigint constraint "PK_ROLE"
        primary key,
    name text not null
);

INSERT INTO public."ROLE" (id, name)
values 	(1, 'Admin'),
          (2, 'User');

create table public."USER"
(
    id          bigint generated by default as identity
        constraint "PK_USER"
            primary key,
    first_name  varchar not null,
    second_name varchar not null,
    patronymic  text,
    email       varchar not null,
    password    varchar not null,
    role_id     bigint not null references public."ROLE" (id)
);

INSERT INTO public."USER" (first_name, second_name, patronymic, email, password, role_id)
values
    ('Ivan', 'Ivanov', 'Ivanovich', 'admin', '8C6976E5B5410415BDE908BD4DEE15DFB167A9C873FC4BB8A81F6F2AB448A918', 1),
    ('Petr', 'Petrov', 'Petrovich', 'user', '04F8996DA763B7A969B1028EE3007569EAF3A635486DDAB211D512C85B9DF8FB', 1);
